<html lang="ja">
	<head>
		<script type="text/javascript" src="./musicData.json"></script>
		<link rel="stylesheet" href="style.css">
	</head>
	<script>
	
		let playData;
	
		function init(){
		
			// localStorage.removeItem("playData");

			playData = localStorage.getItem("playData");
			
			if(playData){
				playData = JSON.parse(playData);
			}else{
				
				playData = new Array();
				
				const initialData = {
					OPEN:false,
					CLEARSTATUS:"NO PLAY",
					PLAYRESULT:"F",
					EXSCORE:0,
					MISSCOUNT:0
				}
				
				musicData.forEach(function(rec){
				
					const copyData = {};
					
					copyData.TITLE = rec.TITLE;
					
					if(rec.SPN){
						copyData.SPN = JSON.parse(JSON.stringify(initialData));
					}
					if(rec.SPH){
						copyData.SPH = JSON.parse(JSON.stringify(initialData));
					}
					if(rec.SPA){
						copyData.SPA = JSON.parse(JSON.stringify(initialData));
					}
					if(rec.DPN){
						copyData.DPN = JSON.parse(JSON.stringify(initialData));
					}
					if(rec.DPH){
						copyData.DPH = JSON.parse(JSON.stringify(initialData));
					}
					if(rec.DPA){
						copyData.DPA = JSON.parse(JSON.stringify(initialData));
					}
					
					playData.push(copyData);
				});
				
				localStorage.setItem("playData", JSON.stringify(playData));
			}
			
			musicData.forEach(function(rec){
			
				for(let i = 0; i < playData.length; i++){
					
					if(rec.TITLE == playData[i].TITLE){
						if(rec.SPN){
							for(let key in playData[i].SPN){
								rec.SPN[key] = playData[i].SPN[key];
							}
						}
						if(rec.SPH){
							for(let key in playData[i].SPH){
								rec.SPH[key] = playData[i].SPH[key];
							}
						}
						if(rec.SPA){
							for(let key in playData[i].SPA){
								rec.SPA[key] = playData[i].SPA[key];
							}
						}
						if(rec.DPN){
							for(let key in playData[i].DPN){
								rec.DPN[key] = playData[i].DPN[key];
							}
						}
						if(rec.DPH){
							for(let key in playData[i].DPH){
								rec.DPH[key] = playData[i].DPH[key];
							}
						}
						if(rec.DPA){
							for(let key in playData[i].DPA){
								rec.DPA[key] = playData[i].DPA[key];
							}
						}
						break;
					}
				}
			});
			
			const spdp = document.forms[0].SPDP.value;
			
			const mergedMusicData = new Array();
			
			const lv = document.forms[0].LV.value;

			musicData.forEach(function(rec){
				if(rec[spdp + "N"]){
					if(rec[spdp + "N"].DIFFICULT == lv){
						mergedMusicData.push({
							TITLE:rec.TITLE,
							BPM:rec.BPM,
							type:"N",
							BSS:rec[spdp + "N"].BSS,
							HBSS:rec[spdp + "N"].HBSS,
							CN:rec[spdp + "N"].CN,
							HCN:rec[spdp + "N"].HCN,
							DIFFICULT:rec[spdp + "N"].DIFFICULT,
							OPEN:rec[spdp + "N"].OPEN,
							CLEARSTATUS:rec[spdp + "N"].CLEARSTATUS,
							PLAYRESULT:rec[spdp + "N"].PLAYRESULT,
							EXSCORE:rec[spdp + "N"].EXSCORE,
							MISSCOUNT:rec[spdp + "N"].MISSCOUNT
						});
					}
				}
				if(rec[spdp + "H"]){
					if(rec[spdp + "H"].DIFFICULT == lv){
						mergedMusicData.push({
							TITLE:rec.TITLE,
							BPM:rec.BPM,
							type:"H",
							BSS:rec[spdp + "H"].BSS,
							HBSS:rec[spdp + "H"].HBSS,
							CN:rec[spdp + "H"].CN,
							HCN:rec[spdp + "H"].HCN,
							DIFFICULT:rec[spdp + "H"].DIFFICULT,
							OPEN:rec[spdp + "H"].OPEN,
							CLEARSTATUS:rec[spdp + "H"].CLEARSTATUS,
							PLAYRESULT:rec[spdp + "H"].PLAYRESULT,
							EXSCORE:rec[spdp + "H"].EXSCORE,
							MISSCOUNT:rec[spdp + "H"].MISSCOUNT
						});
					}
				}
				if(rec[spdp + "A"]){
					if(rec[spdp + "A"].DIFFICULT == lv){
						mergedMusicData.push({
							TITLE:rec.TITLE,
							BPM:rec.BPM,
							type:"A",
							BSS:rec[spdp + "A"].BSS,
							HBSS:rec[spdp + "A"].HBSS,
							CN:rec[spdp + "A"].CN,
							HCN:rec[spdp + "A"].HCN,
							DIFFICULT:rec[spdp + "A"].DIFFICULT,
							OPEN:rec[spdp + "A"].OPEN,
							CLEARSTATUS:rec[spdp + "A"].CLEARSTATUS,
							PLAYRESULT:rec[spdp + "A"].PLAYRESULT,
							EXSCORE:rec[spdp + "A"].EXSCORE,
							MISSCOUNT:rec[spdp + "A"].MISSCOUNT
						});
					}
				}
			});
			
			const dt = document.getElementById("dt");
			dt.innerHTML = null;
			
			mergedMusicData.sort(function(a, b){
			
				if(a.DIFFICULT > b.DIFFICULT){
					return 1;
				}else if(a.DIFFICULT < b.DIFFICULT){
					return -1;
				}
				if(a.TITLE.toUpperCase() > b.TITLE.toUpperCase()){
					return 1;
				}else if(a.TITLE.toUpperCase() < b.TITLE.toUpperCase()){
					return -1;
				}
				return 0;
			});
						
			mergedMusicData.forEach(function(rec){
			
				let r = document.createElement("tr");
				r.style.cursor = "pointer";
				r.setAttribute("title", rec.TITLE);
				r.setAttribute("type", rec.type);
				r.onclick = function(){
					let t = event.target;
					while(t.tagName != "TR"){
						t = t.parentNode;
					}
					const title = t.getAttribute("title");
					const type = t.getAttribute("type");
					openInputForm(title, type);
				}
				
				let color;
				
				if(rec.type == "N"){
					color = "00A0FF";
				}else if(rec.type == "H"){
					color = "FFC000";
				}else if(rec.type == "A"){
					color = "FF0000";
				}
				
				addText(r, rec.DIFFICULT, "width:1.2em;font-size:5.0em;text-align:center;color:#" + color + ";");
				
				const c = document.createElement("td");
				
				let divTitle = document.createElement("div");
				divTitle.innerText = rec.TITLE;
				divTitle.style = "font-size:1.1em;";
				if(!rec.OPEN){
					divTitle.style.color = "gray";
				}
				c.appendChild(divTitle);
				
				let div = document.createElement("div");
				div.style = "display:flex;justify-content:space-between;";
				
				let divA = document.createElement("div");
				
				let divA1 = document.createElement("div");
				divA1.style = "display:flex;justify-content:flex-start;";
				
				let div4 = document.createElement("div");
				div4.innerText = "BPM:" + rec.BPM;
				div4.style.width = "6.5em";
				divA1.appendChild(div4);
				
				let div42 = document.createElement("div");
				if(rec.BSS){
					div42.innerText = "BSS";
				}else if(rec.HBSS){
					div42.innerText = "HBSS";
				}else if(rec.HCN){
					div42.innerText = "HCN";
				}else if(rec.CN){
					div42.innerText = "CN";
				}
				div42.style.width = "30%";
				divA1.appendChild(div42);
				
				let divA2 = document.createElement("div");
				divA2.style = "display:flex;justify-content:flex-start;";
				
				let div5 = document.createElement("div");
				div5.innerText = rec.CLEARSTATUS;
				div5.setAttribute("class", rec.CLEARSTATUS.replaceAll(" ","_"));
				div5.style = "width:6.5em;";
				divA2.appendChild(div5);
				
				let div6 = document.createElement("div");
				div6.innerText = rec.PLAYRESULT;
				div6.setAttribute("class", "PLAYRESULT " + rec.PLAYRESULT);
				div6.style = "width:2.2em;text-align:center;";
				divA2.appendChild(div6);
				
				divA.appendChild(divA1);
				
				divA.appendChild(divA2);
				
				div.appendChild(divA);
				
				let divX = document.createElement("div");
				divX.style = "width:7.0em;";
				
				let div7 = document.createElement("div");
				div7.style = "display:flex;justify-content:space-between;";
				
				let div71 = document.createElement("div");
				div71.innerText = "EX SCORE";
				div7.appendChild(div71);
				
				let div72 = document.createElement("div");
				div72.innerText = rec.EXSCORE;
				div7.appendChild(div72);
				
				divX.appendChild(div7);
				
				let div8 = document.createElement("div");
				div8.style = "display:flex;justify-content:space-between;";
				
				let div81 = document.createElement("div");
				div81.innerText = "MISS COUNT";
				div8.appendChild(div81);
				
				let div82 = document.createElement("div");
				div82.innerText = rec.MISSCOUNT;
				div8.appendChild(div82);
				
				divX.appendChild(div8);
				
				div.appendChild(divX);
				
				c.appendChild(div);
				
				r.appendChild(c);
				
				dt.appendChild(r);
			});
		}
		
		function addText(r, text, style){
			const cell = document.createElement("td");
			cell.innerText = text;
			if(style){
				cell.style = style;
			}
			r.appendChild(cell);
			
			return cell;
		}
		
		function openInputForm(title, type){
			const spdp = document.forms[0].SPDP.value + type;
			for(let i = 0; i < musicData.length; i++){
				if(musicData[i].TITLE == title){
					
					document.getElementById("TITLE").innerText = title;
					document.getElementById("SPDP").innerText = spdp;
					document.getElementById("NOTES").innerText = musicData[i][spdp].NOTES;
					document.getElementById("OPEN").checked = musicData[i][spdp].OPEN;
					document.getElementById("CLEARSTATUS").value = musicData[i][spdp].CLEARSTATUS;
					//document.getElementById("PLAYRESULT").value = musicData[i][spdp].PLAYRESULT;
					document.getElementById("EXSCORE").value = musicData[i][spdp].EXSCORE;
					document.getElementById("MISSCOUNT").value = musicData[i][spdp].MISSCOUNT;
					
					if(musicData[i][spdp].OPEN){
						document.getElementById("CLEARSTATUS").disabled = false;
						document.getElementById("PLAYRESULT").disabled = false;
						document.getElementById("EXSCORE").disabled = false;
						document.getElementById("MISSCOUNT").disabled = false;
					}else{
						document.getElementById("CLEARSTATUS").disabled = true;
						document.getElementById("PLAYRESULT").disabled = true;
						document.getElementById("EXSCORE").disabled = true;
						document.getElementById("MISSCOUNT").disabled = true;
					}
					
					calc(musicData[i][spdp].NOTES, musicData[i][spdp].EXSCORE);
					
					document.getElementById("inputContainer").style.display = "block";
					
					break;
				}
			}
		}
		function cancel(){
			document.getElementById("inputContainer").style.display = "none";
		}
		function save(){
			const title = document.getElementById("TITLE").innerText;
			const spdp = document.getElementById("SPDP").innerText;
			
			for(let i = 0; i < musicData.length; i++){
				if(musicData[i].TITLE == title){
					musicData[i][spdp].OPEN = document.getElementById("OPEN").checked;
					musicData[i][spdp].CLEARSTATUS = document.getElementById("CLEARSTATUS").value;
					musicData[i][spdp].PLAYRESULT= document.getElementById("PLAYRESULT").innerText;
					musicData[i][spdp].EXSCORE= document.getElementById("EXSCORE").value;
					musicData[i][spdp].MISSCOUNT= document.getElementById("MISSCOUNT").value;
					break;
				}
			}
			
			for(let i = 0; i < playData.length; i++){
				if(playData[i].TITLE == title){
					playData[i][spdp].OPEN = document.getElementById("OPEN").checked;
					playData[i][spdp].CLEARSTATUS = document.getElementById("CLEARSTATUS").value;
					playData[i][spdp].PLAYRESULT= document.getElementById("PLAYRESULT").innerText;
					playData[i][spdp].EXSCORE= document.getElementById("EXSCORE").value;
					playData[i][spdp].MISSCOUNT= document.getElementById("MISSCOUNT").value;
					break;
				}
			}
			
			localStorage.setItem("playData", JSON.stringify(playData));
			
			document.getElementById("inputContainer").style.display = "none";
			
			init();
		}
		
		function openChange(){
			if(event.target.checked){
				document.getElementById("CLEARSTATUS").disabled = false;
				document.getElementById("EXSCORE").disabled = false;
				document.getElementById("MISSCOUNT").disabled = false;
			}else{
				document.getElementById("CLEARSTATUS").disabled = true;
				document.getElementById("EXSCORE").disabled = true;
				document.getElementById("MISSCOUNT").disabled = true;
			}
		}
		
		function focusReset(){
			event.target.value = "";
		}
		
		function calcRate(){
			
			calc(parseInt(document.getElementById("NOTES").innerText, 10), event.target.value);
		}
		
		function calc(notes, exscore){
/*
	AAA…8/9以上
	AA…7/9以上
	A…6/9以上
	B…5/9以上
	C…4/9以上
	D…3/9以上
	E…2/9以上
	F…2/9未満
*/					
			const max = notes * 2;	
			const rate = exscore / max;
			
			if(rate >= (8 / 9)){
			
				document.getElementById("PLAYRESULT").innerText = "AAA";
				document.getElementById("PLAYRESULT").setAttribute("class", "PLAYRESULT AAA");
				if(rate >= (85 / 90)){
					document.getElementById("DETAIL").innerText = "(MAX-" + (max - exscore) + ")";
				}else{
					document.getElementById("DETAIL").innerText = "(AAA+" + (exscore - Math.ceil(max * (8 / 9))) + ")";
				}
			}else if(rate >= (7 / 9)){
				document.getElementById("PLAYRESULT").innerText = "AA";
				document.getElementById("PLAYRESULT").setAttribute("class", "PLAYRESULT AA");
				document.getElementById("DETAIL").innerText = "(AAA-" + (Math.ceil(max * (8 / 9)) - exscore) + ")";
			}else if(rate >= (6 / 9)){
				document.getElementById("PLAYRESULT").innerText = "A";
				document.getElementById("PLAYRESULT").setAttribute("class", "PLAYRESULT A");
				document.getElementById("DETAIL").innerText = "(AA-" + (Math.ceil(max * (7 / 9)) - exscore) + ")";
			}else if(rate >= (5 / 9)){
				document.getElementById("PLAYRESULT").innerText = "B";
				document.getElementById("PLAYRESULT").setAttribute("class", "PLAYRESULT B");
				document.getElementById("DETAIL").innerText = "(A-" + (Math.ceil(max * (6 / 9)) - exscore) + ")";
			}else if(rate >= (4 / 9)){
				document.getElementById("PLAYRESULT").innerText = "C";
				document.getElementById("PLAYRESULT").setAttribute("class", "PLAYRESULT C");
				document.getElementById("DETAIL").innerText = "(B-" + (Math.ceil(max * (5 / 9)) - exscore) + ")";
			}else if(rate >= (3 / 9)){
				document.getElementById("PLAYRESULT").innerText = "D";
				document.getElementById("PLAYRESULT").setAttribute("class", "PLAYRESULT D");
				document.getElementById("DETAIL").innerText = "(C-" + (Math.ceil(max * (4 / 9)) - exscore) + ")";
			}else if(rate >= (2 / 9)){
				document.getElementById("PLAYRESULT").innerText = "E";
				document.getElementById("PLAYRESULT").setAttribute("class", "PLAYRESULT E");
				document.getElementById("DETAIL").innerText = "(D-" + (Math.ceil(max * (3 / 9)) - exscore) + ")";
			}else{
				document.getElementById("PLAYRESULT").innerText = "F";
				document.getElementById("PLAYRESULT").setAttribute("class", "PLAYRESULT F");
				if(exscore != 0){
					document.getElementById("DETAIL").innerText = "(E-" + (Math.ceil(max * (2 / 9)) - exscore) + ")";
				}else{
					document.getElementById("DETAIL").innerText = "";
				}
			}
		}
	</script>
	<body onload="init();">
		<div id="inputContainer" style="width:calc(100% - 1.0em - 30px);display:none;position:absolute;z-index:2;background-color:black;border:7px solid gray;padding:0.5em;">
			<div><span id="TITLE"></span>(<span id="SPDP"></span>)</div>
			<div>TOTAL NOTES<span id="NOTES" style="margin-left:0.2em;"></span></div>
			<div id="inputArea">
				<div><input type="checkbox" id="OPEN" onchange="openChange();"/><label for="OPEN">曲解禁済</label></div>
				<div>クリア状況</div>
				<div>
					<select id="CLEARSTATUS" style="padding-left:0.2em;padding-right:0.2em;">
						<option value="NO PLAY">NO PLAY</option>
						<option value="FAILED">FAILED</option>
						<option value="ASSIST CLEAR">ASSIST CLEAR</option>
						<option value="EASY CLEAR">EASY CLEAR</option>
						<option value="CLEAR">CLEAR</option>
						<option value="HARD CLEAR">HARD CLEAR</option>
						<option value="EX HARD CLEAR">EX HARD CLEAR</option>
						<option value="FULL COMBO">FULL COMBO</option>
					</select>
				</div>
				<div>リザルト</div>
				<div style="display:flex;justify-content:flex-start;">
					<div id="PLAYRESULT" style="width:2.2em;text-align:center;"></div>
					<div id="DETAIL"></div>
				</div>
				<div>EX SCORE</div>
				<div>
					<input type="number" id="EXSCORE" min="0" max="9999" style="width:4em;text-align:right;padding-right:0.2em;" onfocus="focusReset();" onchange="calcRate();"/>
				</div>
				<div>MISS COUNT</div>
				<div>
					<input type="number" id="MISSCOUNT" min="0" max="9999" style="width:4em;text-align:right;padding-right:0.2em;" onfocus="focusReset();"/>
				</div>
			</div>
			<div style="text-align:center;margin-top:0.8em;">
				<button type="button" onclick="cancel();" style="padding-left:0.3em;padding-right:0.3em;">キャンセル</button>
				<button type="button" onclick="save();" style="padding-left:0.3em;padding-right:0.3em;">更新</button>
			</div>
		</div>
		<form>
			<div style="padding-top:0.5em;padding-left:0.5em;display:flex;justify-content:flex-start;">
				<div style="margin-right:0.5em;">
					<select name="SPDP" value="SP" onchange="init();" style="padding-left:0.2em;padding-right:0.2em;">
						<option value="SP">SP</option>
						<option value="DP">DP</option>
					</select>
				</div>
				<div>
					<select name="LV" value="1" onchange="init();" style="padding-left:0.2em;padding-right:0.2em;">
						<option value="1">LEVEL 1</option>
						<option value="2">LEVEL 2</option>
						<option value="3">LEVEL 3</option>
						<option value="4">LEVEL 4</option>
						<option value="5">LEVEL 5</option>
						<option value="6">LEVEL 6</option>
						<option value="7">LEVEL 7</option>
						<option value="8">LEVEL 8</option>
						<option value="9">LEVEL 9</option>
						<option value="10">LEVEL 10</option>
						<option value="11">LEVEL 11</option>
						<option value="12">LEVEL 12</option>
					</select>
				</div>
			</div>
		</form>
		<div style="height:92.5%;overflow-y:scroll;">
			<table id="dt"></table>
		</div>
	</body>
	
</html>