<html lang="ja">
	<head>
		<script type="text/javascript" src="./musicData.json"></script>
	</head>
	<script>
	
		let playData;
	
		function init(){
		
			// localStorage.removeItem("playData");
		
			playData = localStorage.getItem("playData");
			
			if(playData){
				playData = JSON.parse(playData);
			}else{
				
				playData = new Array();
				
				const initialData = {
					OPEN:false,
					CLEARSTATUS:"NO PLAY",
					PLAYRESULT:"F",
					EXSCORE:0,
					MISSCOUNT:0
				}
				
				musicData.forEach(function(rec){
				
					const copyData = {};
					
					copyData.TITLE = rec.TITLE;
					
					if(rec.SPN){
						copyData.SPN = JSON.parse(JSON.stringify(initialData));
					}
					if(rec.SPH){
						copyData.SPH = JSON.parse(JSON.stringify(initialData));
					}
					if(rec.SPA){
						copyData.SPA = JSON.parse(JSON.stringify(initialData));
					}
					if(rec.DPN){
						copyData.DPN = JSON.parse(JSON.stringify(initialData));
					}
					if(rec.DPH){
						copyData.DPH = JSON.parse(JSON.stringify(initialData));
					}
					if(rec.DPA){
						copyData.DPA = JSON.parse(JSON.stringify(initialData));
					}
					
					playData.push(copyData);
				});
				
				localStorage.setItem("playData", JSON.stringify(playData));
			}
			
			console.log(JSON.stringify(playData));
			
			musicData.forEach(function(rec){
				for(let i = 0; i < playData.length; i++){
					
					if(rec.TITLE == playData[i].TITLE){
						if(rec.SPN){
							for(let key in playData[i].SPN){
								rec.SPN[key] = playData[i].SPN[key];
							}
						}
						if(rec.SPH){
							for(let key in playData[i].SPH){
								rec.SPH[key] = playData[i].SPH[key];
							}
						}
						if(rec.SPA){
							for(let key in playData[i].SPA){
								rec.SPA[key] = playData[i].SPA[key];
							}
						}
						if(rec.DPN){
							for(let key in playData[i].DPN){
								rec.DPN[key] = playData[i].DPN[key];
							}
						}
						if(rec.DPH){
							for(let key in playData[i].DPH){
								rec.DPH[key] = playData[i].DPH[key];
							}
						}
						if(rec.DPA){
							for(let key in playData[i].DPA){
								rec.DPA[key] = playData[i].DPA[key];
							}
						}
						break;
					}
				}
			});
			
			const dt = document.getElementById("dt");
			dt.innerHTML = null;
			
			const spdp = document.forms[0].SPDP.value;
			
			musicData.sort(function(a, b){
			
				if(!a[spdp] && !b[spdp]){
					return 0;
				}else if(a[spdp] && !b[spdp]){
					return 1;
				}else if(!a[spdp] && b[spdp]){
					return -1;
				}
			
				if(a[spdp].DIFFICULT > b[spdp].DIFFICULT){
					return 1;
				}else if(a[spdp].DIFFICULT < b[spdp].DIFFICULT){
					return -1;
				}
				if(a.TITLE > b.TITLE){
					return 1;
				}else if(a.TITLE < b.TITLE){
					return -1;
				}
				return 0;
			});
						
			musicData.forEach(function(rec){
				if(rec[spdp]){
					const r = document.createElement("tr");
					r.style.cursor = "pointer";
					r.onclick = function(){
						let t = event.target;
						if(t.tagName == "TD"){
							t = t.parentNode;
						}
						const title = t.getElementsByTagName("TD")[2].innerText;
						openInputForm(title);
					}
					let color;

					if(spdp.substring(2, 3) == "N"){
						color = "00A0FF";
					}else if(spdp.substring(2, 3) == "H"){
						color = "FFC000";
					}else if(spdp.substring(2, 3) == "A"){
						color = "FF0000";
					}
					if(rec[spdp].BSS){
						addText(r, "BSS", "text-align:center;");
					}else if(rec[spdp].HBSS){
						addText(r, "HBSS", "text-align:center;");
					}else if(rec[spdp].HCN){
						addText(r, "HCN", "text-align:center;");
					}else if(rec[spdp].CN){
						addText(r, "CN", "text-align:center;");
					}else{
						addText(r, "", "text-align:center;");
					}
					addText(r, rec[spdp].DIFFICULT, "text-align:center;color:#" + color + ";");
					if(rec[spdp].OPEN){
						addText(r, rec.TITLE);
					}else{
						addText(r, rec.TITLE, "color:gray;");
					}
					
					addText(r, rec.BPM, "text-align:center;");
					
					for(let idx = 0; idx < playData.length; idx++){
						if(rec.TITLE == playData[idx].TITLE){
							addText(r, playData[idx][spdp].CLEARSTATUS, "text-align:center;").setAttribute("class", playData[idx][spdp].CLEARSTATUS.replaceAll(" ","_"));
							addText(r, playData[idx][spdp].PLAYRESULT, "text-align:center;").setAttribute("class", "PLAYRESULT " + playData[idx][spdp].PLAYRESULT);
							addText(r, playData[idx][spdp].EXSCORE, "text-align:right;")
							addText(r, playData[idx][spdp].MISSCOUNT, "text-align:right;");
							break;
						}
					}

					dt.appendChild(r);
				}
			});
		}
		
		function addText(r, text, style){
			const cell = document.createElement("td");
			cell.innerText = text;
			if(style){
				cell.style = style;
			}
			r.appendChild(cell);
			
			return cell;
		}
		
		function openInputForm(title){
			const spdp = document.forms[0].SPDP.value;
			for(let i = 0; i < musicData.length; i++){
				if(musicData[i].TITLE == title){
					
					document.getElementById("TITLE").innerText = title;
					document.getElementById("SPDP").innerText = spdp;
					document.getElementById("OPEN").checked = musicData[i][spdp].OPEN;
					document.getElementById("CLEARSTATUS").value = musicData[i][spdp].CLEARSTATUS;
					document.getElementById("PLAYRESULT").value = musicData[i][spdp].PLAYRESULT;
					document.getElementById("EXSCORE").value = musicData[i][spdp].EXSCORE;
					document.getElementById("MISSCOUNT").value = musicData[i][spdp].MISSCOUNT;
					
					document.getElementById("inputContainer").style.display = "block";
					
					break;
				}
			}
		}
		function cancel(){
			document.getElementById("inputContainer").style.display = "none";
		}
		function save(){
			const title = document.getElementById("TITLE").innerText;
			const spdp = document.getElementById("SPDP").innerText;
			
			for(let i = 0; i < musicData.length; i++){
				if(musicData[i].TITLE == title){
					musicData[i][spdp].OPEN = document.getElementById("OPEN").checked;
					musicData[i][spdp].CLEARSTATUS = document.getElementById("CLEARSTATUS").value;
					musicData[i][spdp].PLAYRESULT= document.getElementById("PLAYRESULT").value;
					musicData[i][spdp].EXSCORE= document.getElementById("EXSCORE").value;
					musicData[i][spdp].MISSCOUNT= document.getElementById("MISSCOUNT").value;
					break;
				}
			}
			
			for(let i = 0; i < playData.length; i++){
				if(playData[i].TITLE == title){
					playData[i][spdp].OPEN = document.getElementById("OPEN").checked;
					playData[i][spdp].CLEARSTATUS = document.getElementById("CLEARSTATUS").value;
					playData[i][spdp].PLAYRESULT= document.getElementById("PLAYRESULT").value;
					playData[i][spdp].EXSCORE= document.getElementById("EXSCORE").value;
					playData[i][spdp].MISSCOUNT= document.getElementById("MISSCOUNT").value;
					break;
				}
			}
			
			localStorage.setItem("playData", JSON.stringify(playData));
			
			document.getElementById("inputContainer").style.display = "none";
			
			init();
		}
	</script>
	<style type="text/css">
		body{
			user-select:none;
			background-color:black;
			color:white;
			font-size:1.5em;
		}
		input,select,button{
			font-size:1.1em;
		}
		#dt{
			border-collapse: separate;
		    border-spacing: 0px 8px;
		}
		#dt tr:hover{
			background-color:rgba(255,255,255,0.1);
		}
		#dt th,#dt td{
			font-size:1.5em;
			padding:0.3em 0.5em 0.3em 0.5em;
		}
		#dt tr td:nth-child(2){
			border-left:2px solid #D0D0D0;
		    border-radius:10px 0px 0px 10px;
		}
		#dt tr td:not(:nth-child(1)){
			border-top:2px solid #D0D0D0;
			border-bottom:2px solid #D0D0D0;
		}
		#dt tr td:last-child{
			border-right:2px solid #D0D0D0;
		    border-radius:0px 10px 10px 0px;
		}
		#inputArea{
			font-size:1.0em;
		}
		#inputArea tr td:nth-child(1){
			padding-right:0.5em;
		}
		/* 元々のチェックボックス（非表示） */
		input[type="checkbox"]{
			display: none;
		}
		/* チェックボックスの代わりを成すラベル */
		input[type="checkbox"]+label{
			display: none;
			cursor: pointer;
			display: inline-block;
			position: relative;
			padding-left: 25px;
			padding-right: 10px;
		}
		/* ラベルの左に表示させる正方形のボックス□ */
		input[type="checkbox"]+label::before{
			content: "";
			position: absolute;
			display: block;
			box-sizing: border-box;
			width:20px;
			height:20px;
			margin-top:-12px;
			left: 0;
			top: 50%;
			border: 1px solid;
			border-color:  #585753; /* 枠の色変更 お好きな色を */
			background-color: #FFF; /* 背景の色変更 お好きな色を */
		}
		/* チェックが入った時のレ点 */
		input[type="checkbox"]:checked+label::after{
			content:"";
			position:absolute;
			display:block;
			box-sizing:border-box;
			width:18px;
			height:9px;
			margin-top:-10px;
			top:50%;
			left:3px;
			transform:rotate(-45deg);
			border-bottom:3px solid;
			border-left:3px solid;
			border-color:#585753; /* チェックの色変更 お好きな色を */
		}
		.PLAYRESULT{
			text-shadow:
				 2px  2px 0 black,
				-2px -2px 0 black,
				-2px  2px 0 black,
				 2px -2px 0 black,
				 0px  2px 0 black,
				 0   -2px 0 black,
				-2px  0   0 black,
				 2px  0   0 black;
		}
		.AAA{
			background:linear-gradient(#FFCC00 49%, #303030 1%, #FFCC00);
		}
		.A{
			background:linear-gradient(#00FFC0 49%, #303030 1%, #00FFC0);
		}
		.NO_PLAY{
			color:#00CCFF;
		}
		.FAILED{
			color:#FF0000;
		}
		.EASY_CLEAR{
			color:#00FF00;
		}
		.CLEAR{
			color:#00FFC0;
		}
		.HARD_CLEAR{
			color:#FF0000;
		}
		.EX_HARD_CLEAR{
			color:#FFE000;
		}
		.FULL_COMBO{
			animation:flash 0.25s linear infinite;
		}
		@keyframes flash{
			24%,74%{
				color:white;
			}
			25%{
				color:red;
			}
			75%{
				color:blue;
			}
		}
	</style>
	<body onload="init();">
		<div id="inputContainer" style="display:none;position:absolute;z-index:2;background-color:black;border:2px solid gray;padding:0.75em;">
			<div><span id="TITLE"></span>(<span id="SPDP"></span>)</div>
			<table id="inputArea">
				<tr>
					<td colspan="2"><input type="checkbox" id="OPEN"/><label for="OPEN">曲解禁済</label></td>
				</tr>
				<tr>
					<td>クリア状況</td>
					<td>
						<select id="CLEARSTATUS">
							<option value="NO PLAY">NO PLAY</option>
							<option value="FAILED">FAILED</option>
							<option value="ASSIST CLEAR">ASSIST CLEAR</option>
							<option value="EASY CLEAR">EASY CLEAR</option>
							<option value="CLEAR">CLEAR</option>
							<option value="HARD CLEAR">HARD CLEAR</option>
							<option value="EX HARD CLEAR">EX HARD CLEAR</option>
							<option value="FULL COMBO">FULL COMBO</option>
						</select>
					</td>
				</tr>
				<tr>
					<td>リザルト</td>
					<td>
						<select id="PLAYRESULT">
							<option value="F">F</option>
							<option value="E">E</option>
							<option value="D">D</option>
							<option value="C">C</option>
							<option value="B">B</option>
							<option value="A">A</option>
							<option value="AA">AA</option>
							<option value="AAA">AAA</option>
						</select>
					</td>
				</tr>
				<tr>
					<td>EX SCORE</td>
					<td>
						<input type="number" id="EXSCORE" min="0" max="9999" style="width:4em;"/>
					</td>
				</tr>
				<tr>
					<td>MISS COUNT</td>
					<td>
						<input type="number" id="MISSCOUNT" min="0" max="9999" style="width:4em;"/>
					</td>
				</tr>
			</table>
			<div style="text-align:center;margin-top:0.8em;">
				<button type="button" onclick="cancel();">キャンセル</button>
				<button type="button" onclick="save();">更新</button>
			</div>
		</div>
		<form>
			<select name="SPDP" value="SPN" onchange="init();">
				<option value="SPN">SPN</option>
				<option value="SPH">SPH</option>
				<option value="SPA">SPA</option>
				<option value="DPN">DPN</option>
				<option value="DPH">DPH</option>
				<option value="DPA">DPA</option>
			</select>
		</form>
		<div style="height:92.5%;overflow-y:scroll;">
			<table id="dt"></table>
		</div>
	</body>
	
</html>